/**********************************************************************
 * 文件名: PI_Cale.c
 * 创建日期: 2017年1月4日
 * 作者: XQ
 * 功能概述: PI控制器的实现文件
 * 本代码仅用于学习使用，未经允许不得用于其他任何用途
 * 版权所有：硕力电子
 * DSP/STM32开发板设计
 * 淘宝店铺：硕力电子
 * 网址: https://shuolidianzi.taobao.com
 * 修改日期: 2017/1/23
 * 版本：V17.3-1
 * 作者QQ: 616264123
 * 技术交流QQ群：314306105
 **********************************************************************/

/* 包含头文件 */
#include "PI_Cale.h"

/* 全局PI控制器实例声明 */
PI_Control   pi_spd;    // 速度环PI控制器
PI_Control   pi_id;     // d轴电流PI控制器
PI_Control   pi_iq;     // q轴电流PI控制器

/**
 * @brief  PI控制器计算函数
 * @param  pV: PI控制器结构体指针
 * @note   实现PI控制的核心算法，包括比例项和积分项的计算
 * @retval 无
 */
void PI_Controller(p_PI_Control pV)
{
    /* 计算比例项：误差值 */
    pV->up = pV->Ref - pV->Fbk;

    /* 计算积分项：
     * 如果输出未饱和，更新积分项
     * 如果输出饱和，保持积分项不变（抗积分饱和）
     */
    pV->ui = (pV->Out == pV->v1) ? (_IQmpy(pV->Ki, pV->up) + pV->i1) : pV->i1;
    pV->i1 = pV->ui;  // 保存当前积分值用于下次计算

    /* 计算控制输出：比例项和积分项之和 */
    pV->v1 = _IQmpy(pV->Kp, pV->up) + pV->ui;
    /* 输出限幅处理 */
    pV->Out = IQsat(pV->v1, pV->Umax, pV->Umin);
}

/**
 * @brief  PI控制器参数初始化函数
 * @param  无
 * @note   初始化速度环和电流环的PI控制器参数
 * @retval 无
 */
void PI_Pare_init(void)
{
    /* 速度环PI参数配置 */
    pi_spd.Kp = 18000;    // 速度环比例系数
    pi_spd.Ki = 260;      // 速度环积分系数
    pi_spd.Umax = 30000;  // 速度环输出上限
    pi_spd.Umin = 0;      // 速度环输出下限

    /* d轴电流环PI参数配置 */
    pi_id.Kp = 21;        // d轴电流环比例系数
    pi_id.Ki = 880;       // d轴电流环积分系数
    pi_id.Umax = 5000;    // d轴电流环输出上限
    pi_id.Umin = -5000;   // d轴电流环输出下限

    /* q轴电流环PI参数配置 */
    pi_iq.Kp = 2680;      // q轴电流环比例系数
    pi_iq.Ki = 236;       // q轴电流环积分系数
    pi_iq.Umax = 30000;   // q轴电流环输出上限
    pi_iq.Umin = 0;       // q轴电流环输出下限
}

//===========================================================================
// 文件结束
//===========================================================================

